<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CiteFlex Unified - Citation Workbench</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /*
         * CiteFlex Unified - Workbench UI
         * Version: 2.2.0
         * Updated: 2025-12-10
         * 
         * V2.2.0 Changes:
         * - Added AI-powered lookup for Author-Date citations
         * - New /api/cite/parenthetical integration
         * - Radio button selection for AI options
         * 
         * V2.1.0 Changes:
         * - Added mode toggle (Footnote vs Author-Date)
         * - Different workflows for each mode
         * - Author-Date: extracts (Author, Year), generates References
         * - Supports APA, Harvard, Chicago Author-Date, ASA, AAA, Turabian
         */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Merriweather:ital,wght@0,300;0,400;0,700;1,300;1,400&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .serif { font-family: 'Merriweather', serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .loader {
            border: 3px solid #e2e8f0;
            border-radius: 50%;
            border-top: 3px solid #2563eb;
            width: 20px;
            height: 20px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .animate-pulse-once { animation: pulseOnce 0.5s ease-out; }
        @keyframes pulseOnce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
        
        /* Citation type badges */
        .badge-legal { background: #fef3c7; color: #92400e; }
        .badge-journal { background: #d1fae5; color: #065f46; }
        .badge-book { background: #dbeafe; color: #1e40af; }
        .badge-medical { background: #fce7f3; color: #9d174d; }
        .badge-interview { background: #e0e7ff; color: #3730a3; }
        .badge-newspaper { background: #f3e8ff; color: #6b21a8; }
        .badge-government { background: #fee2e2; color: #991b1b; }
        .badge-unknown { background: #f1f5f9; color: #475569; }
        
        /* Status indicators */
        .status-pending { border-left: 3px solid #94a3b8; }
        .status-success { border-left: 3px solid #22c55e; background: #f0fdf4; }
        .status-error { border-left: 3px solid #ef4444; background: #fef2f2; }
        .status-pending { border-left: 3px solid #f59e0b; background: #fffbeb; }
        .status-active { border-left: 3px solid #3b82f6; background: #eff6ff; }
        
        /* Mode toggle */
        .mode-toggle { display: flex; background: #f1f5f9; border-radius: 8px; padding: 3px; }
        .mode-btn { 
            flex: 1; 
            padding: 8px 16px; 
            border-radius: 6px; 
            font-size: 13px; 
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            background: transparent;
            color: #64748b;
        }
        .mode-btn.active { 
            background: white; 
            color: #1e40af;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .mode-btn:hover:not(.active) { color: #475569; }
        
        /* Tooltip */
        .tooltip { position: relative; }
        .tooltip:hover::after {
            content: attr(data-tip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 100;
        }
        
        /* Reference list styling */
        .reference-item {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            background: white;
            margin-bottom: 8px;
            transition: all 0.2s;
        }
        .reference-item:hover { border-color: #3b82f6; }
        .reference-item.resolved { border-left: 3px solid #22c55e; }
        .reference-item.failed { border-left: 3px solid #ef4444; background: #fef2f2; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 shadow-sm z-20 px-6 h-16 flex items-center justify-between flex-shrink-0">
        <div class="flex items-center gap-4">
            <div class="bg-gradient-to-br from-blue-600 to-indigo-600 text-white w-10 h-10 flex items-center justify-center rounded-lg shadow-sm">
                <i class="fas fa-quote-left text-lg"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold text-gray-900 tracking-tight">CiteFlex <span class="text-blue-600">Unified</span></h1>
                <p class="text-xs text-gray-500 font-medium">Best-in-Breed Citation Workbench <span id="app-version">v2.1</span></p>
            </div>
        </div>
        
        <div class="flex items-center gap-3">
            <div class="hidden md:flex items-center gap-2 text-xs text-gray-500 bg-gray-100 px-3 py-1.5 rounded-full">
                <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                <span>65 cases cached • 6 styles • Multi-engine</span>
            </div>
            <button onclick="window.location.reload()" class="text-gray-500 hover:text-gray-700 font-medium text-sm px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors">
                <i class="fas fa-redo mr-1"></i> Reset
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex overflow-hidden">
        
        <!-- Left Sidebar: Mode Toggle, Upload & Citation List -->
        <aside class="w-80 lg:w-96 bg-white border-r border-gray-200 flex flex-col z-10 flex-shrink-0">
            
            <!-- Mode Toggle -->
            <div class="p-4 border-b border-gray-100 bg-gradient-to-b from-slate-50 to-white">
                <div class="mode-toggle">
                    <button id="mode-footnote" class="mode-btn active" onclick="setMode('footnote')">
                        <i class="fas fa-superscript mr-1"></i> Footnotes
                    </button>
                    <button id="mode-author-date" class="mode-btn" onclick="setMode('author-date')">
                        <i class="fas fa-user-clock mr-1"></i> Author-Date
                    </button>
                </div>
                <p id="mode-description" class="text-xs text-gray-400 mt-2 text-center">
                    Chicago, Bluebook, OSCOLA footnotes
                </p>
            </div>
            
            <!-- Upload Area -->
            <div class="p-4 border-b border-gray-100 bg-gradient-to-b from-gray-50 to-white">
                <input type="file" id="file-input" class="hidden" accept=".docx">
                <button onclick="document.getElementById('file-input').click()" class="w-full border-2 border-dashed border-gray-300 rounded-xl p-5 text-center hover:border-blue-500 hover:bg-blue-50 transition-all cursor-pointer group flex flex-col items-center gap-2">
                    <i class="fas fa-cloud-upload-alt text-2xl text-gray-400 group-hover:text-blue-500 transition-colors"></i>
                    <span class="text-sm font-medium text-gray-600 group-hover:text-blue-700">Upload Document (.docx)</span>
                    <span id="upload-hint" class="text-xs text-gray-400">Endnotes & footnotes will be extracted</span>
                </button>
                
                <!-- Style Selector -->
                <div class="mt-3 flex items-center gap-2">
                    <label for="style-selector" class="text-xs font-medium text-gray-600">Citation Style:</label>
                    <select id="style-selector" class="flex-1 text-sm border border-gray-300 rounded-lg bg-white text-gray-700 h-9 px-3 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none cursor-pointer">
                        <!-- Footnote styles (default) -->
                        <option value="Chicago Manual of Style">Chicago (17th)</option>
                        <option value="Turabian">Turabian (9th)</option>
                        <option value="MLA">MLA (9th)</option>
                        <option value="Vancouver">Vancouver (Medical)</option>
                        <option value="Bluebook">Bluebook (US Legal)</option>
                        <option value="OSCOLA">OSCOLA (UK Legal)</option>
                    </select>
                </div>
                
                <div id="upload-loading" class="hidden mt-3 flex items-center justify-center gap-2 text-xs text-gray-500">
                    <div class="loader w-4 h-4"></div> <span>Parsing document structure...</span>
                </div>
                
                <!-- Processing Overlay -->
                <div id="processing-overlay" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center">
                    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md mx-4 text-center">
                        <div class="mb-6">
                            <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full mb-4">
                                <i class="fas fa-magic text-white text-2xl animate-pulse"></i>
                            </div>
                            <h3 id="processing-title" class="text-xl font-bold text-gray-800">Processing Document</h3>
                            <p id="processing-subtitle" class="text-gray-500 text-sm mt-1">Analyzing your citations...</p>
                        </div>
                        
                        <div class="space-y-3">
                            <div id="processing-status" class="text-sm text-gray-600">
                                <span class="inline-block w-2 h-2 bg-blue-500 rounded-full animate-ping mr-2"></span>
                                Extracting citations...
                            </div>
                            
                            <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                                <div id="processing-progress" class="bg-gradient-to-r from-blue-500 to-purple-600 h-2 rounded-full transition-all duration-500" style="width: 10%"></div>
                            </div>
                            
                            <p class="text-xs text-gray-400 mt-4">
                                This may take a moment for complex documents
                            </p>
                        </div>
                    </div>
                </div>
                
                <div id="file-info" class="hidden mt-3 flex items-center justify-between bg-blue-50 px-3 py-2 rounded-lg">
                    <span class="text-sm text-blue-700 font-medium truncate" id="file-name-display"></span>
                    <button onclick="resetDocument()" class="text-blue-600 hover:text-blue-800 text-xs">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div id="download-area" class="hidden mt-3">
                    <button onclick="downloadDocument()" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-medium py-2.5 px-4 rounded-lg transition-all text-sm shadow-sm flex items-center justify-center gap-2">
                        <i class="fas fa-file-download"></i> Download Processed Document
                    </button>
                </div>
            </div>

            <!-- Stats Bar -->
            <div class="px-4 py-2 bg-white border-b border-gray-100 flex justify-between items-center">
                <span id="list-label" class="text-xs font-bold text-gray-400 uppercase tracking-wider">Citations</span>
                <div class="flex items-center gap-2">
                    <span id="success-count" class="hidden text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full font-medium">0 done</span>
                    <span id="citation-count" class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-600 font-medium">0 total</span>
                </div>
            </div>

            <!-- Citation/Reference List -->
            <div id="citation-list" class="flex-1 overflow-y-auto">
                <div id="list-empty" class="text-center py-12 text-gray-400">
                    <i class="fas fa-inbox text-4xl mb-3 opacity-30"></i>
                    <p class="text-sm font-medium">Upload a document to begin</p>
                    <p id="list-empty-hint" class="text-xs mt-1">Endnotes and footnotes will appear here</p>
                </div>
            </div>
            
            <!-- Quick Lookup (always visible) -->
            <div class="p-4 border-t border-gray-200 bg-gray-50">
                <div class="flex gap-2">
                    <input type="text" id="quick-query" placeholder="Quick lookup: title, case, DOI..." 
                           class="flex-1 text-sm px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    <button onclick="quickLookup()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Editor Panel -->
        <section id="editor-panel" class="flex-1 bg-gray-50 flex flex-col overflow-hidden">
            
            <!-- Empty State -->
            <div id="editor-empty" class="flex flex-col items-center justify-center h-full text-gray-400">
                <i class="fas fa-mouse-pointer text-5xl mb-4 opacity-20"></i>
                <p class="text-lg font-medium">Select a citation to resolve</p>
                <p class="text-sm mt-1">Or use quick lookup below the list</p>
            </div>

            <!-- Active Editor (Footnote Mode) -->
            <div id="editor-active" class="hidden flex-1 overflow-y-auto p-6 lg:p-8">
                <div class="max-w-4xl mx-auto w-full space-y-6 animate-fade-in">
                    
                    <!-- Original Text Card -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider flex items-center gap-2">
                                <i class="fas fa-file-alt text-gray-300"></i> Original Citation
                            </h3>
                            <div class="flex items-center gap-2">
                                <span id="active-type" class="text-[10px] font-bold uppercase px-2 py-0.5 rounded badge-unknown">detecting...</span>
                                <span id="active-id" class="text-xs font-mono text-gray-400">Note #</span>
                            </div>
                        </div>
                        <div id="active-original" class="text-gray-800 serif italic p-4 bg-gradient-to-br from-gray-50 to-slate-50 rounded-lg border border-gray-100 leading-relaxed text-lg"></div>
                    </div>

                    <!-- Final Editor -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border-2 border-blue-200 ring-2 ring-blue-50">
                        <h3 class="text-xs font-bold text-blue-600 uppercase mb-3 flex items-center gap-2">
                            <i class="fas fa-pen-nib"></i> Final Citation
                            <span class="text-[10px] font-normal text-gray-400 ml-2">(auto-resolved — edit or select alternative below)</span>
                        </h3>
                        <textarea id="final-edit-area" class="w-full p-4 border border-gray-300 rounded-lg serif text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none resize-y min-h-[120px] leading-relaxed" placeholder="Auto-resolved citation will appear here..."></textarea>
                        
                        <div class="flex gap-3 mt-4 pt-4 border-t border-gray-100">
                            <button onclick="commitChange()" id="commit-btn" class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-medium py-3 rounded-lg transition-all shadow-sm flex items-center justify-center gap-2">
                                <i class="fas fa-check"></i> Accept & Save
                            </button>
                            <button onclick="copyToClipboard()" class="px-5 py-3 bg-white text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition-colors border border-gray-200 shadow-sm flex items-center gap-2 tooltip" data-tip="Copy to clipboard">
                                <i class="fas fa-copy text-gray-400"></i>
                            </button>
                            <button onclick="appendMode()" class="px-5 py-3 bg-white text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition-colors border border-gray-200 shadow-sm flex items-center gap-2 tooltip" data-tip="Append another source">
                                <i class="fas fa-plus text-gray-400"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Candidates Section -->
                    <div id="candidates-section">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider flex items-center gap-2">
                                <i class="fas fa-magic text-gray-300"></i> Alternative Resolutions
                            </h3>
                            
                            <button onclick="searchCandidates()" class="text-xs text-blue-600 font-medium hover:bg-blue-50 p-2 rounded-lg transition-colors tooltip" data-tip="Refresh results">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        
                        <div id="candidates-list" class="space-y-3">
                            <!-- Candidates will be inserted here -->
                        </div>
                    </div>
                    
                    <!-- Navigation -->
                    <div class="flex justify-between items-center pt-2">
                        <button onclick="navigateCitation(-1)" id="prev-btn" class="text-sm text-gray-500 hover:text-gray-700 flex items-center gap-1 disabled:opacity-30 disabled:cursor-not-allowed">
                            <i class="fas fa-arrow-left"></i> Previous
                        </button>
                        <span id="nav-position" class="text-xs text-gray-400">1 of 10</span>
                        <button onclick="navigateCitation(1)" id="next-btn" class="text-sm text-gray-500 hover:text-gray-700 flex items-center gap-1 disabled:opacity-30 disabled:cursor-not-allowed">
                            Next <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>

                </div>
            </div>
            
            <!-- Author-Date Results Panel -->
            <div id="author-date-results" class="hidden flex-1 overflow-y-auto p-6 lg:p-8">
                <div class="max-w-4xl mx-auto w-full space-y-6 animate-fade-in">
                    
                    <!-- Original Citation Card -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider flex items-center gap-2">
                                <i class="fas fa-file-alt text-gray-300"></i> Original Citation
                            </h3>
                            <div class="flex items-center gap-2">
                                <span id="ad-active-type" class="text-[10px] font-bold uppercase px-2 py-0.5 rounded badge-unknown">detecting...</span>
                                <span id="ad-active-id" class="text-xs font-mono text-gray-400">Ref #</span>
                            </div>
                        </div>
                        <div id="ad-active-original" class="text-gray-800 serif italic p-4 bg-gradient-to-br from-gray-50 to-slate-50 rounded-lg border border-gray-100 leading-relaxed text-lg"></div>
                    </div>

                    <!-- Final Editor -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border-2 border-blue-200 ring-2 ring-blue-50">
                        <h3 class="text-xs font-bold text-blue-600 uppercase mb-3 flex items-center gap-2">
                            <i class="fas fa-pen-nib"></i> Final Citation
                            <span class="text-[10px] font-normal text-gray-400 ml-2">(select option below or edit manually)</span>
                        </h3>
                        <textarea id="ad-final-edit-area" class="w-full p-4 border border-gray-300 rounded-lg serif text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none resize-y min-h-[120px] leading-relaxed" placeholder="Select an option below or type manually..."></textarea>
                        
                        <div class="flex gap-3 mt-4 pt-4 border-t border-gray-100">
                            <button onclick="adCommitChange()" id="ad-commit-btn" class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-medium py-3 rounded-lg transition-all shadow-sm flex items-center justify-center gap-2">
                                <i class="fas fa-check"></i> Accept & Save
                            </button>
                            <button onclick="adCopyToClipboard()" class="px-5 py-3 bg-white text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition-colors border border-gray-200 shadow-sm flex items-center gap-2 tooltip" data-tip="Copy to clipboard">
                                <i class="fas fa-copy text-gray-400"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Alternative Resolutions Section -->
                    <div id="ad-candidates-section">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider flex items-center gap-2">
                                <i class="fas fa-magic text-gray-300"></i> Alternative Resolutions
                            </h3>
                            <span id="ad-options-count" class="text-xs text-gray-400">0 options</span>
                        </div>
                        
                        <div id="ad-candidates-list" class="space-y-3">
                            <!-- Candidates will be inserted here -->
                        </div>
                    </div>
                    
                    <!-- Navigation -->
                    <div class="flex justify-between items-center pt-2">
                        <button onclick="adNavigateCitation(-1)" id="ad-prev-btn" class="text-sm text-gray-500 hover:text-gray-700 flex items-center gap-1 disabled:opacity-30 disabled:cursor-not-allowed">
                            <i class="fas fa-arrow-left"></i> Previous
                        </button>
                        <span id="ad-nav-position" class="text-xs text-gray-400">1 of 10</span>
                        <button onclick="adNavigateCitation(1)" id="ad-next-btn" class="text-sm text-gray-500 hover:text-gray-700 flex items-center gap-1 disabled:opacity-30 disabled:cursor-not-allowed">
                            Next <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>

                </div>
            </div>
        </section>
    </main>

    <script>
        /*
         * CiteFlex Unified - Frontend Logic
         * Version: 2.2.0
         * Updated: 2025-12-10
         */
        
        // State
        let currentMode = 'footnote';  // 'footnote' or 'author-date'
        let currentCitations = [];
        let currentReferences = [];
        let activeNoteId = null;
        let activeNoteIndex = -1;
        let activeRefIndex = -1;
        let adActiveRefIndex = -1;  // Author-Date mode active reference
        let sessionId = null;
        let successCount = 0;
        let documentStyle = 'Chicago Manual of Style';

        // Style options for each mode
        const footnoteStyles = [
            { value: 'Chicago Manual of Style', label: 'Chicago (17th)' },
            { value: 'Turabian', label: 'Turabian (9th)' },
            { value: 'MLA', label: 'MLA (9th)' },
            { value: 'Vancouver', label: 'Vancouver (Medical)' },
            { value: 'Bluebook', label: 'Bluebook (US Legal)' },
            { value: 'OSCOLA', label: 'OSCOLA (UK Legal)' }
        ];
        
        const authorDateStyles = [
            { value: 'APA', label: 'APA (7th)' },
            { value: 'Harvard', label: 'Harvard' },
            { value: 'Chicago Author-Date', label: 'Chicago Author-Date' },
            { value: 'ASA', label: 'ASA (Sociology)' },
            { value: 'Turabian Author-Date', label: 'Turabian Author-Date' }
        ];

        // Fetch app version
        fetch('/api/version')
            .then(r => r.json())
            .then(data => {
                if (data.version) {
                    document.getElementById('app-version').textContent = 'v' + data.version;
                }
            })
            .catch(() => {});

        // ========== MODE TOGGLE ==========
        function setMode(mode) {
            currentMode = mode;
            
            // Update toggle buttons
            document.getElementById('mode-footnote').classList.toggle('active', mode === 'footnote');
            document.getElementById('mode-author-date').classList.toggle('active', mode === 'author-date');
            
            // Update description
            const desc = document.getElementById('mode-description');
            if (mode === 'footnote') {
                desc.textContent = 'Chicago, Bluebook, OSCOLA footnotes';
            } else {
                desc.textContent = 'APA, Harvard in-text citations';
            }
            
            // Update upload hint
            const hint = document.getElementById('upload-hint');
            const listHint = document.getElementById('list-empty-hint');
            if (mode === 'footnote') {
                hint.textContent = 'Endnotes & footnotes will be extracted';
                listHint.textContent = 'Endnotes and footnotes will appear here';
            } else {
                hint.textContent = '(Author, Year) citations will be extracted';
                listHint.textContent = 'In-text citations will appear here';
            }
            
            // Update list label
            document.getElementById('list-label').textContent = mode === 'footnote' ? 'Citations' : 'References';
            
            // Update style selector
            updateStyleSelector();
            
            // Reset document if loaded
            if (sessionId) {
                resetDocument();
            }
        }
        
        function updateStyleSelector() {
            const selector = document.getElementById('style-selector');
            const styles = currentMode === 'footnote' ? footnoteStyles : authorDateStyles;
            
            selector.innerHTML = styles.map(s => 
                `<option value="${s.value}">${s.label}</option>`
            ).join('');
        }

        // ========== FILE UPLOAD ==========
        document.getElementById('file-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            if (currentMode === 'footnote') {
                await processFootnoteDocument(file);
            } else {
                await processAuthorDateDocument(file);
            }
        });

        async function processFootnoteDocument(file) {
            const loading = document.getElementById('upload-loading');
            const fileInfo = document.getElementById('file-info');
            const overlay = document.getElementById('processing-overlay');
            const status = document.getElementById('processing-status');
            const progress = document.getElementById('processing-progress');
            
            // Update overlay text
            document.getElementById('processing-title').textContent = 'CitateGenie Processing';
            document.getElementById('processing-subtitle').textContent = 'Analyzing your footnotes...';
            
            overlay.classList.remove('hidden');
            loading.classList.remove('hidden');
            fileInfo.classList.add('hidden');
            
            // Animate progress
            let progressValue = 10;
            const statusMessages = [
                { pct: 10, msg: 'Extracting endnotes and footnotes...' },
                { pct: 25, msg: 'Analyzing citation patterns...' },
                { pct: 40, msg: 'Searching academic databases...' },
                { pct: 55, msg: 'Verifying with PubMed & Crossref...' },
                { pct: 70, msg: 'Resolving ambiguous references...' },
                { pct: 85, msg: 'Formatting citations...' },
            ];
            let msgIndex = 0;
            
            const progressInterval = setInterval(() => {
                if (msgIndex < statusMessages.length) {
                    const target = statusMessages[msgIndex].pct;
                    if (progressValue < target) {
                        progressValue += 2;
                        progress.style.width = progressValue + '%';
                    } else {
                        status.innerHTML = `<span class="inline-block w-2 h-2 bg-blue-500 rounded-full animate-ping mr-2"></span>${statusMessages[msgIndex].msg}`;
                        msgIndex++;
                    }
                }
            }, 300);
            
            const formData = new FormData();
            formData.append('file', file);
            documentStyle = document.getElementById('style-selector').value;
            formData.append('style', documentStyle);
            
            try {
                const res = await fetch('/api/process', { method: 'POST', body: formData });
                const data = await res.json();
                
                clearInterval(progressInterval);
                progress.style.width = '100%';
                status.innerHTML = '<span class="inline-block w-2 h-2 bg-green-500 rounded-full mr-2"></span>Complete!';
                
                await new Promise(r => setTimeout(r, 500));
                
                if (data.success) {
                    sessionId = data.session_id;
                    currentCitations = data.notes || [];
                    successCount = 0;
                    
                    document.getElementById('citation-count').innerText = `${currentCitations.length} total`;
                    document.getElementById('file-name-display').innerText = file.name;
                    fileInfo.classList.remove('hidden');
                    document.getElementById('download-area').classList.remove('hidden');
                    
                    renderCitationList();
                    
                    // Show footnote editor
                    document.getElementById('editor-empty').classList.add('hidden');
                    document.getElementById('author-date-results').classList.add('hidden');
                    
                    if (currentCitations.length > 0) {
                        loadEditor(currentCitations[0], 0);
                    }
                } else {
                    alert('Error: ' + (data.error || 'Failed to process document'));
                }
            } catch (err) {
                clearInterval(progressInterval);
                console.error(err);
                alert('Upload failed: ' + err.message);
            } finally {
                loading.classList.add('hidden');
                overlay.classList.add('hidden');
            }
        }

        async function processAuthorDateDocument(file) {
            const loading = document.getElementById('upload-loading');
            const fileInfo = document.getElementById('file-info');
            const overlay = document.getElementById('processing-overlay');
            const status = document.getElementById('processing-status');
            const progress = document.getElementById('processing-progress');
            
            // Update overlay text
            document.getElementById('processing-title').textContent = 'Building References';
            document.getElementById('processing-subtitle').textContent = 'Extracting in-text citations...';
            
            overlay.classList.remove('hidden');
            loading.classList.remove('hidden');
            fileInfo.classList.add('hidden');
            
            // Animate progress
            let progressValue = 10;
            const statusMessages = [
                { pct: 10, msg: 'Extracting (Author, Year) citations...' },
                { pct: 25, msg: 'Identifying unique sources...' },
                { pct: 40, msg: 'Searching Semantic Scholar...' },
                { pct: 55, msg: 'Querying Crossref & OpenAlex...' },
                { pct: 70, msg: 'Matching authors and years...' },
                { pct: 85, msg: 'Generating reference list...' },
            ];
            let msgIndex = 0;
            
            const progressInterval = setInterval(() => {
                if (msgIndex < statusMessages.length) {
                    const target = statusMessages[msgIndex].pct;
                    if (progressValue < target) {
                        progressValue += 2;
                        progress.style.width = progressValue + '%';
                    } else {
                        status.innerHTML = `<span class="inline-block w-2 h-2 bg-blue-500 rounded-full animate-ping mr-2"></span>${statusMessages[msgIndex].msg}`;
                        msgIndex++;
                    }
                }
            }, 400);
            
            const formData = new FormData();
            formData.append('file', file);
            documentStyle = document.getElementById('style-selector').value;
            formData.append('style', documentStyle);
            
            try {
                const res = await fetch('/api/process-author-date', { method: 'POST', body: formData });
                const data = await res.json();
                
                clearInterval(progressInterval);
                progress.style.width = '100%';
                status.innerHTML = '<span class="inline-block w-2 h-2 bg-green-500 rounded-full mr-2"></span>Complete!';
                
                await new Promise(r => setTimeout(r, 500));
                
                if (data.success) {
                    sessionId = data.session_id;
                    
                    // Transform citations from backend into references format for UI
                    // Now using raw metadata (formatting happens on Accept & Save)
                    currentReferences = (data.citations || []).map(citation => {
                        // Parse "(Author, Year)" from original text
                        const original = citation.original || '';
                        const match = original.match(/\(([^,]+?)(?:\s+et\s+al\.)?(?:\s*[&,]\s*([^,]+?))?,\s*(\d{4}[a-z]?)\)/i);
                        
                        let author = '', secondAuthor = '', year = '', isEtAl = false;
                        if (match) {
                            author = match[1]?.trim() || '';
                            secondAuthor = match[2]?.trim() || '';
                            year = match[3] || '';
                            isEtAl = /et\s+al/i.test(original);
                        }
                        
                        // Check if AI lookup succeeded (more than just the original option)
                        const hasOptions = citation.options && citation.options.length > 1;
                        
                        return {
                            id: citation.id,
                            note_id: citation.note_id,
                            original: original,
                            author: author,
                            second_author: secondAuthor,
                            year: year,
                            is_et_al: isEtAl,
                            found: hasOptions,
                            options: citation.options || [],
                            selected_option: citation.selected_option || (hasOptions ? 1 : 0),
                            formatted: null,  // Will be set on Accept & Save
                            accepted: false
                        };
                    });
                    
                    document.getElementById('citation-count').innerText = `${currentReferences.length} refs`;
                    document.getElementById('file-name-display').innerText = file.name;
                    fileInfo.classList.remove('hidden');
                    document.getElementById('download-area').classList.remove('hidden');
                    
                    // Render sidebar
                    renderReferenceSidebar();
                    
                    // Show author-date results with first reference loaded
                    document.getElementById('editor-empty').classList.add('hidden');
                    document.getElementById('editor-active').classList.add('hidden');
                    document.getElementById('author-date-results').classList.remove('hidden');
                    
                    // Load first reference into editor
                    if (currentReferences.length > 0) {
                        await adLoadEditor(0);
                    }
                    
                } else {
                    alert('Error: ' + (data.error || 'Failed to process document'));
                }
            } catch (err) {
                clearInterval(progressInterval);
                console.error(err);
                alert('Upload failed: ' + err.message);
            } finally {
                loading.classList.add('hidden');
                overlay.classList.add('hidden');
            }
        }

        // ========== CITATION LIST (Footnote Mode) ==========
        function renderCitationList() {
            const list = document.getElementById('citation-list');
            const empty = document.getElementById('list-empty');
            
            if (currentCitations.length === 0) {
                if (empty) empty.classList.remove('hidden');
                return;
            }
            
            if (empty) empty.classList.add('hidden');
            list.innerHTML = currentCitations.map((c, idx) => {
                const statusClass = c.success ? 'status-success' : 'status-pending';
                const badgeClass = `badge-${c.type || 'unknown'}`;
                const icon = c.success ? 'fa-check text-green-500' : 'fa-clock text-gray-400';
                return `
                    <div id="note-${c.id}" onclick="loadEditor(currentCitations[${idx}], ${idx})" 
                         class="p-3 cursor-pointer hover:bg-gray-50 transition-colors ${statusClass}">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-xs font-mono text-gray-400">Note ${c.id}</span>
                            <span class="text-[10px] font-bold uppercase px-1.5 py-0.5 rounded ${badgeClass}">${c.type || '?'}</span>
                        </div>
                        <p class="text-sm text-gray-700 truncate">
                            <i class="fas ${icon} mr-1"></i>
                            ${c.text.substring(0, 60)}${c.text.length > 60 ? '...' : ''}
                        </p>
                    </div>
                `;
            }).join('');
        }

        // ========== REFERENCE LIST (Author-Date Mode) ==========
        function renderReferenceSidebar() {
            const list = document.getElementById('citation-list');
            const empty = document.getElementById('list-empty');
            
            if (currentReferences.length === 0) {
                if (empty) empty.classList.remove('hidden');
                return;
            }
            
            if (empty) empty.classList.add('hidden');
            list.innerHTML = currentReferences.map((ref, idx) => {
                const isActive = idx === adActiveRefIndex;
                const statusClass = ref.accepted ? 'status-success' : (ref.found ? 'status-pending' : 'status-error');
                const icon = ref.accepted ? 'fa-check text-green-500' : 
                            (ref.found ? 'fa-clock text-yellow-500' : 'fa-exclamation-triangle text-red-500');
                const citationText = ref.is_et_al 
                    ? `${ref.author} et al. (${ref.year})`
                    : ref.second_author 
                        ? `${ref.author} & ${ref.second_author} (${ref.year})`
                        : `${ref.author} (${ref.year})`;
                        
                // Get preview text (truncated formatted or title from selected option)
                let previewText = 'Pending...';
                if (ref.formatted) {
                    previewText = ref.formatted.replace(/<\/?i>/g, '').substring(0, 50) + '...';
                } else if (ref.options && ref.options[ref.selected_option || 1]) {
                    const opt = ref.options[ref.selected_option || 1];
                    previewText = opt.title ? opt.title.substring(0, 50) + '...' : 'Click to resolve';
                }
                
                return `
                    <div id="ref-${ref.id}" onclick="adSelectReference(${idx})" 
                         class="p-3 cursor-pointer hover:bg-gray-50 transition-colors ${statusClass} ${isActive ? 'status-active' : ''}">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-xs font-medium text-gray-600">${citationText}</span>
                            <i class="fas ${icon}"></i>
                        </div>
                        <p class="text-xs text-gray-500 truncate">${previewText}</p>
                    </div>
                `;
            }).join('');
        }
        
        // ========== AUTHOR-DATE EDITOR ==========
        
        async function adSelectReference(idx) {
            // Auto-save current if not accepted and has content
            if (adActiveRefIndex >= 0 && adActiveRefIndex !== idx) {
                const currentRef = currentReferences[adActiveRefIndex];
                const textarea = document.getElementById('ad-final-edit-area');
                if (textarea && textarea.value.trim() && !currentRef.accepted) {
                    // Auto-accept current before moving
                    await adCommitChange(true);  // silent = true
                }
            }
            await adLoadEditor(idx);
        }
        
        async function adLoadEditor(idx) {
            adActiveRefIndex = idx;
            const ref = currentReferences[idx];
            
            // Update sidebar highlighting
            document.querySelectorAll('#citation-list > div').forEach(el => {
                el.classList.remove('status-active');
            });
            const activeEl = document.getElementById(`ref-${ref.id}`);
            if (activeEl) activeEl.classList.add('status-active');
            
            // Populate Original Citation
            document.getElementById('ad-active-id').innerText = `Ref ${ref.id}`;
            document.getElementById('ad-active-original').innerText = ref.original;
            
            // Set type badge from selected option
            const typeEl = document.getElementById('ad-active-type');
            const selectedOpt = ref.options[ref.selected_option || 1] || ref.options[0];
            const citationType = selectedOpt?.citation_type || 'unknown';
            typeEl.innerText = citationType;
            typeEl.className = `text-[10px] font-bold uppercase px-2 py-0.5 rounded badge-${citationType}`;
            
            // Populate Final Citation textarea
            const textarea = document.getElementById('ad-final-edit-area');
            if (ref.formatted) {
                // Already formatted - show it
                textarea.value = ref.formatted;
            } else if (ref.options.length > 1) {
                // Pre-populate with first AI option (formatted)
                textarea.value = 'Loading...';
                const firstOption = ref.options[1];  // First AI option (index 0 is "keep original")
                const formatted = await formatMetadata(firstOption);
                textarea.value = formatted;
            } else {
                // No options - show empty
                textarea.value = '';
                textarea.placeholder = 'Type citation manually...';
            }
            
            // Render alternative options
            adRenderCandidates(ref);
            
            // Update navigation
            adUpdateNavigation();
        }
        
        function adRenderCandidates(ref) {
            const container = document.getElementById('ad-candidates-list');
            const countEl = document.getElementById('ad-options-count');
            
            // Filter to non-original options
            const options = ref.options.filter(opt => !opt.is_original);
            countEl.innerText = `${options.length} option${options.length !== 1 ? 's' : ''}`;
            
            if (options.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-6 text-gray-400 bg-white rounded-lg border border-gray-200">
                        <i class="fas fa-search text-2xl mb-2 opacity-30"></i>
                        <p class="text-sm">No matches found</p>
                        <p class="text-xs mt-1">Type the citation manually above</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = options.map((opt, idx) => {
                const actualIdx = idx + 1;  // +1 because we skipped the original option
                const isSelected = actualIdx === ref.selected_option;
                const typeBadgeClass = `badge-${opt.citation_type || 'unknown'}`;
                
                // Build author string - show ALL authors for clarity
                let authorStr = '';
                if (opt.authors && opt.authors.length > 0) {
                    if (opt.authors.length === 1) {
                        authorStr = opt.authors[0];
                    } else if (opt.authors.length === 2) {
                        authorStr = opt.authors.join(' & ');
                    } else {
                        // Show all authors: "Author1, Author2, & Author3"
                        const lastAuthor = opt.authors[opt.authors.length - 1];
                        const otherAuthors = opt.authors.slice(0, -1);
                        authorStr = otherAuthors.join(', ') + ', & ' + lastAuthor;
                    }
                }
                
                // Build details line
                let details = [];
                if (opt.journal) details.push(`<em>${opt.journal}</em>`);
                if (opt.publisher) details.push(opt.publisher);
                if (opt.volume) details.push(`Vol. ${opt.volume}`);
                if (opt.year) details.push(opt.year);
                const detailsStr = details.join(' · ');
                
                return `
                    <div onclick="adSelectCandidate(${actualIdx})" 
                         class="p-4 bg-white rounded-lg border ${isSelected ? 'border-blue-400 ring-2 ring-blue-100' : 'border-gray-200'} hover:border-blue-300 cursor-pointer transition-all">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] font-bold uppercase px-2 py-0.5 rounded ${typeBadgeClass}">${opt.citation_type || 'unknown'}</span>
                                ${opt.source ? `<span class="text-[10px] text-gray-400">${opt.source}</span>` : ''}
                            </div>
                            ${isSelected ? '<i class="fas fa-check-circle text-blue-500"></i>' : ''}
                        </div>
                        <p class="font-medium text-gray-800 mb-1">${opt.title || 'Untitled'}</p>
                        <p class="text-sm text-gray-600">${authorStr}${authorStr && detailsStr ? ' · ' : ''}${detailsStr}</p>
                        ${opt.doi ? `<p class="text-xs text-blue-600 mt-1">DOI: ${opt.doi}</p>` : ''}
                    </div>
                `;
            }).join('');
        }
        
        async function adSelectCandidate(optIdx) {
            if (adActiveRefIndex < 0) return;
            
            const ref = currentReferences[adActiveRefIndex];
            ref.selected_option = optIdx;
            
            // Get the selected option metadata
            const opt = ref.options[optIdx];
            if (!opt) return;
            
            // Format the citation via backend
            const formatted = await formatMetadata(opt);
            
            // Put in textarea
            document.getElementById('ad-final-edit-area').value = formatted;
            
            // Re-render to show selection
            adRenderCandidates(ref);
        }
        
        async function formatMetadata(metadata) {
            try {
                const res = await fetch('/api/format-citation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        metadata: metadata,
                        style: documentStyle
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    return data.formatted;
                } else {
                    console.error('Format error:', data.error);
                    return '';
                }
            } catch (err) {
                console.error('Format error:', err);
                return '';
            }
        }
        
        async function adCommitChange(silent = false) {
            if (adActiveRefIndex < 0) return;
            
            const ref = currentReferences[adActiveRefIndex];
            const textarea = document.getElementById('ad-final-edit-area');
            let finalText = textarea.value.trim();
            
            // If empty, try to format the selected option
            if (!finalText && ref.options[ref.selected_option]) {
                finalText = await formatMetadata(ref.options[ref.selected_option]);
                textarea.value = finalText;
            }
            
            // If still empty and has options, format the first AI option
            if (!finalText && ref.options.length > 1) {
                finalText = await formatMetadata(ref.options[1]);
                textarea.value = finalText;
            }
            
            // If still empty, use original
            if (!finalText) {
                finalText = ref.original;
            }
            
            // Save to local state
            ref.formatted = finalText;
            ref.accepted = true;
            
            // Persist to server
            if (sessionId) {
                try {
                    await fetch('/api/accept-reference', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_id: sessionId,
                            reference_id: ref.id,
                            formatted: finalText
                        })
                    });
                } catch (err) {
                    console.error('Failed to persist reference:', err);
                }
            }
            
            // Update sidebar
            renderReferenceSidebar();
            
            if (!silent) {
                showToast('Citation accepted');
            }
        }
        
        async function adNavigateCitation(delta) {
            // Auto-save current before navigating
            if (adActiveRefIndex >= 0) {
                const currentRef = currentReferences[adActiveRefIndex];
                const textarea = document.getElementById('ad-final-edit-area');
                
                // If there's content in textarea and not yet accepted, auto-accept
                if (textarea.value.trim() || currentRef.options.length > 1) {
                    await adCommitChange(true);  // silent = true
                }
            }
            
            const newIdx = adActiveRefIndex + delta;
            if (newIdx >= 0 && newIdx < currentReferences.length) {
                await adLoadEditor(newIdx);
            }
        }
        
        function adUpdateNavigation() {
            document.getElementById('ad-nav-position').innerText = `${adActiveRefIndex + 1} of ${currentReferences.length}`;
            document.getElementById('ad-prev-btn').disabled = adActiveRefIndex <= 0;
            document.getElementById('ad-next-btn').disabled = adActiveRefIndex >= currentReferences.length - 1;
        }
        
        function adCopyToClipboard() {
            const textarea = document.getElementById('ad-final-edit-area');
            navigator.clipboard.writeText(textarea.value).then(() => {
                showToast('Copied to clipboard');
            }).catch(err => {
                console.error('Copy failed:', err);
            });
        }
        
        // Helper to render HTML with italics
        function renderWithItalics(text) {
            if (!text) return '';
            return text.replace(/<i>/g, '<em>').replace(/<\/i>/g, '</em>');
        }

        // ========== FOOTNOTE EDITOR ==========
        function loadEditor(citation, idx) {
            activeNoteId = citation.id;
            activeNoteIndex = idx;
            
            // Update sidebar highlighting
            document.querySelectorAll('#citation-list > div').forEach(el => {
                el.classList.remove('status-active');
            });
            const activeEl = document.getElementById(`note-${citation.id}`);
            if (activeEl) activeEl.classList.add('status-active');
            
            // Show editor
            document.getElementById('editor-empty').classList.add('hidden');
            document.getElementById('editor-active').classList.remove('hidden');
            document.getElementById('author-date-results').classList.add('hidden');
            
            // Populate editor
            document.getElementById('active-id').innerText = `Note ${citation.id}`;
            document.getElementById('active-original').innerText = citation.text;
            
            // Set type badge
            const typeEl = document.getElementById('active-type');
            typeEl.innerText = citation.type || 'detecting...';
            typeEl.className = `text-[10px] font-bold uppercase px-2 py-0.5 rounded badge-${citation.type || 'unknown'}`;
            
            // Pre-populate with auto-resolved result
            document.getElementById('final-edit-area').value = citation.formatted || '';
            
            // Update navigation
            updateNavigation();
            
            // Show navigation buttons
            document.getElementById('prev-btn').classList.remove('hidden');
            document.getElementById('next-btn').classList.remove('hidden');
            
            // Search for alternatives
            searchCandidates();
        }
        
        function updateNavigation() {
            document.getElementById('nav-position').innerText = `${activeNoteIndex + 1} of ${currentCitations.length}`;
            document.getElementById('prev-btn').disabled = activeNoteIndex <= 0;
            document.getElementById('next-btn').disabled = activeNoteIndex >= currentCitations.length - 1;
        }
        
        async function navigateCitation(delta) {
            // Auto-save current before navigating
            if (activeNoteId && sessionId) {
                const textarea = document.getElementById('final-edit-area');
                if (textarea && textarea.value.trim()) {
                    await commitChange(true);  // silent = true
                }
            }
            
            const newIdx = activeNoteIndex + delta;
            if (newIdx >= 0 && newIdx < currentCitations.length) {
                loadEditor(currentCitations[newIdx], newIdx);
            }
        }

        async function searchCandidates() {
            const container = document.getElementById('candidates-list');
            container.innerHTML = `
                <div class="flex items-center justify-center py-8 text-gray-400">
                    <div class="loader mr-2"></div> Searching databases...
                </div>
            `;
            
            const query = document.getElementById('active-original').innerText;
            if (!query) return;
            
            try {
                const res = await fetch('/api/cite/multiple', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        query, 
                        style: documentStyle, 
                        limit: 5 
                    })
                });
                
                const data = await res.json();
                
                if (data.success && data.results && data.results.length > 0) {
                    container.innerHTML = data.results.map((r, i) => `
                        <div onclick="selectCandidate(${i})" class="p-4 bg-white rounded-lg border border-gray-200 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition-all group">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-[10px] font-bold uppercase px-1.5 py-0.5 rounded badge-${r.type}">${r.type}</span>
                                <span class="text-xs text-gray-400">${r.source}</span>
                            </div>
                            <p class="text-sm text-gray-700 serif leading-relaxed">${r.citation}</p>
                        </div>
                    `).join('');
                    
                    // Store for selection
                    window.candidateResults = data.results;
                } else {
                    container.innerHTML = `
                        <div class="text-center py-6 text-gray-400">
                            <i class="fas fa-search text-2xl mb-2 opacity-30"></i>
                            <p class="text-sm">No alternatives found</p>
                        </div>
                    `;
                }
            } catch (err) {
                console.error(err);
                container.innerHTML = `
                    <div class="text-center py-6 text-red-400">
                        <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                        <p class="text-sm">Search failed</p>
                    </div>
                `;
            }
        }
        
        function selectCandidate(idx) {
            if (window.candidateResults && window.candidateResults[idx]) {
                document.getElementById('final-edit-area').value = window.candidateResults[idx].citation;
            }
        }

        async function commitChange(silent = false) {
            if (!activeNoteId || !sessionId) {
                if (!silent) showToast('No citation selected');
                return;
            }
            
            const btn = document.getElementById('commit-btn');
            const originalHtml = btn.innerHTML;
            
            if (!silent) {
                btn.innerHTML = '<div class="loader mx-auto"></div>';
                btn.disabled = true;
            }
            
            const newText = document.getElementById('final-edit-area').value;
            
            try {
                const res = await fetch('/api/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        note_id: activeNoteId,
                        html: newText
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    // Update local state
                    currentCitations[activeNoteIndex].formatted = newText;
                    currentCitations[activeNoteIndex].success = true;
                    
                    // Update sidebar
                    const listItem = document.getElementById(`note-${activeNoteId}`);
                    if (listItem) {
                        listItem.classList.remove('status-pending', 'status-active');
                        listItem.classList.add('status-success');
                        listItem.querySelector('p').innerHTML = `<i class="fas fa-check text-green-500 mr-1"></i>${newText.substring(0, 60)}...`;
                    }
                    
                    successCount++;
                    document.getElementById('success-count').innerText = `${successCount} done`;
                    document.getElementById('success-count').classList.remove('hidden');
                    
                    if (!silent) {
                        btn.innerHTML = `<i class="fas fa-check"></i> Saved!`;
                        btn.classList.remove('from-blue-600', 'to-indigo-600');
                        btn.classList.add('from-green-600', 'to-emerald-600');
                        
                        setTimeout(() => {
                            btn.innerHTML = originalHtml;
                            btn.classList.remove('from-green-600', 'to-emerald-600');
                            btn.classList.add('from-blue-600', 'to-indigo-600');
                            btn.disabled = false;
                            
                            if (activeNoteIndex < currentCitations.length - 1) {
                                navigateCitation(1);
                            }
                        }, 1000);
                    }
                } else {
                    if (!silent) {
                        btn.innerHTML = originalHtml;
                        btn.disabled = false;
                        alert('Failed to save: ' + data.error);
                    }
                }
            } catch (err) {
                if (!silent) {
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                    console.error(err);
                    alert('Failed to save changes');
                }
            }
        }

        // ========== UTILITIES ==========
        function resetDocument() {
            sessionId = null;
            currentCitations = [];
            currentReferences = [];
            activeNoteId = null;
            activeNoteIndex = -1;
            activeRefIndex = -1;
            adActiveRefIndex = -1;  // Reset author-date mode state
            successCount = 0;
            
            document.getElementById('file-info').classList.add('hidden');
            document.getElementById('download-area').classList.add('hidden');
            document.getElementById('success-count').classList.add('hidden');
            document.getElementById('citation-count').innerText = '0 total';
            
            // Recreate list-empty if it was removed by sidebar rendering
            const listEmpty = document.getElementById('list-empty');
            const citationList = document.getElementById('citation-list');
            if (listEmpty) {
                listEmpty.classList.remove('hidden');
            }
            // Reset citation list to contain empty placeholder
            citationList.innerHTML = `
                <div id="list-empty" class="text-center py-12 text-gray-400">
                    <i class="fas fa-inbox text-4xl mb-3 opacity-30"></i>
                    <p class="text-sm font-medium">Upload a document to begin</p>
                    <p id="list-empty-hint" class="text-xs mt-1">${currentMode === 'footnote' ? 'Endnotes and footnotes will appear here' : 'In-text citations will appear here'}</p>
                </div>
            `;
            
            document.getElementById('editor-empty').classList.remove('hidden');
            document.getElementById('editor-active').classList.add('hidden');
            document.getElementById('author-date-results').classList.add('hidden');
            document.getElementById('file-input').value = '';
        }
        
        function appendMode() {
            const area = document.getElementById('final-edit-area');
            area.value = area.value.trim() + "; ";
            area.focus();
            area.setSelectionRange(area.value.length, area.value.length);
        }

        function copyToClipboard() {
            const text = document.getElementById('final-edit-area').value;
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied to clipboard');
            });
        }

        async function downloadDocument() {
            if (!sessionId) {
                showToast('No document loaded');
                return;
            }
            
            // For author-date mode, finalize the document first
            if (currentMode === 'author-date') {
                showToast('Preparing document...');
                
                // Collect all references with their formatted text
                const references = currentReferences.map(ref => ({
                    original: ref.original,
                    formatted: ref.formatted || ref.original
                }));
                
                try {
                    const res = await fetch('/api/finalize-author-date', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_id: sessionId,
                            references: references
                        })
                    });
                    
                    const data = await res.json();
                    
                    if (!data.success) {
                        showToast('Error: ' + (data.error || 'Failed to finalize'));
                        return;
                    }
                } catch (err) {
                    console.error('Finalize error:', err);
                    showToast('Error preparing document');
                    return;
                }
            }
            
            window.location.href = `/api/download/${sessionId}`;
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-4 py-2 rounded-lg shadow-lg text-sm z-50 animate-fade-in';
            toast.innerText = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ========== QUICK LOOKUP ==========
        async function quickLookup() {
            const query = document.getElementById('quick-query').value.trim();
            if (!query) return;
            
            documentStyle = document.getElementById('style-selector').value;
            
            // Show editor with this query
            document.getElementById('editor-empty').classList.add('hidden');
            document.getElementById('editor-active').classList.remove('hidden');
            document.getElementById('author-date-results').classList.add('hidden');
            
            document.getElementById('active-id').innerText = 'Quick Lookup';
            document.getElementById('active-original').innerText = query;
            document.getElementById('final-edit-area').value = '';
            document.getElementById('active-type').innerText = 'searching...';
            document.getElementById('active-type').className = 'text-[10px] font-bold uppercase px-2 py-0.5 rounded badge-unknown';
            
            activeNoteId = null;
            activeNoteIndex = -1;
            
            // Hide navigation
            document.getElementById('prev-btn').classList.add('hidden');
            document.getElementById('next-btn').classList.add('hidden');
            document.getElementById('nav-position').innerText = 'Quick Lookup';
            
            await searchCandidates();
        }

        // Enter key for quick lookup
        document.getElementById('quick-query').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                quickLookup();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                if (currentMode === 'footnote') {
                    commitChange();
                } else if (adActiveRefIndex >= 0) {
                    adCommitChange();
                }
            }
            if (e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'INPUT') {
                if (e.key === 'ArrowLeft') {
                    if (currentMode === 'footnote') {
                        navigateCitation(-1);
                    } else {
                        adNavigateCitation(-1);
                    }
                }
                if (e.key === 'ArrowRight') {
                    if (currentMode === 'footnote') {
                        navigateCitation(1);
                    } else {
                        adNavigateCitation(1);
                    }
                }
            }
        });
    </script>
</body>
</html>
